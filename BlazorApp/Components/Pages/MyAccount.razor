@page "/myaccount"
@using DBL
@using Models
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject ProtectedSessionStorage MySession
@inject NavigationManager nav

<div class="account-container">
    @if (user == null)
    {
        <div class="card">
            <p class="error">❌ You are not logged in.</p>
            <button class="btn" @onclick="@(() => nav.NavigateTo("/login"))">Go to Login</button>
        </div>
    }
    else
    {
        <div class="card">
            <h2 class="logo">🐾 PawMatch</h2>
            <h3>Welcome, @user.FirstName!</h3>

            @if (!isEditing)
            {
                <p><b>First Name:</b> @user.FirstName</p>
                <p><b>Last Name:</b> @user.LastName</p>
                <p><b>Email:</b> @user.Email</p>
                <p><b>Phone:</b> @user.Phone</p>

                <button class="btn" @onclick="() => isEditing = true">Edit Details</button>
                <button class="btn gray" @onclick="Logout">Logout</button>

                @if (user.IsAdmin)
                {
                    <button class="btn blue" @onclick="@(() => nav.NavigateTo("/admin"))">Go to Admin Panel</button>
                }

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <p class="success">@successMessage</p>
                }

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <p class="error">@errorMessage</p>
                }
            }
            else
            {
                <EditForm Model="@user" OnValidSubmit="UpdateUser">
                    <InputText @bind-Value="user.FirstName" placeholder="First name" class="input" />
                    <InputText @bind-Value="user.LastName" placeholder="Last name" class="input" />
                    <InputText @bind-Value="user.Phone" placeholder="Phone" class="input" />
                    <InputText @bind-Value="user.Password" placeholder="Password" type="password" class="input" />
                    <button class="btn" type="submit">Save</button>
                    <button class="btn gray" @onclick="CancelEdit">Cancel</button>
                </EditForm>
            }
        </div>
    }
</div>

@code {
    Customer user;
    bool isEditing = false;
    string successMessage = "";
    string errorMessage = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var result = await MySession.GetAsync<Customer>("customer");
            if (result.Success && result.Value != null)
            {
                user = result.Value;
                StateHasChanged();
            }
            else
            {
                nav.NavigateTo("/login");
            }
        }
    }

    async Task UpdateUser()
    {
        try
        {
            CustomerDB db = new CustomerDB();
            int rows = await db.UpdateAsync(user);
            if (rows > 0)
            {
                successMessage = "✅ Update successful!";
                errorMessage = "";
                isEditing = false;
            }
            else
            {
                errorMessage = "❌ Update failed.";
                successMessage = "";
            }
        }
        catch
        {
            errorMessage = "❌ An error occurred while updating.";
            successMessage = "";
        }
    }

    void CancelEdit()
    {
        isEditing = false;
        successMessage = "";
        errorMessage = "";
    }

    async Task Logout()
    {
        await MySession.DeleteAsync("customer");
        nav.NavigateTo("/login");
    }
}

<style>
    .account-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background: #f8faf9;
    }

    .card {
        background: white;
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        width: 350px;
        text-align: center;
    }

    .logo {
        color: #2e5f3e;
        margin-bottom: 20px;
    }

    .input {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border: 1px solid #ccc;
        border-radius: 8px;
    }

    .btn {
        width: 100%;
        background-color: #2e5f3e;
        color: white;
        padding: 10px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 10px;
    }

        .btn:hover {
            background-color: #3b724a;
        }

        .btn.gray {
            background-color: #777;
        }

        .btn.blue {
            background-color: #2e7d9f;
        }

    .success {
        color: green;
        margin-top: 10px;
    }

    .error {
        color: red;
        margin-top: 10px;
    }
</style>
