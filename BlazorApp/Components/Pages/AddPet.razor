@page "/addpet"
@using DBL
@using Models
@using Microsoft.AspNetCore.Components.Forms
@using System.Linq

<div class="addpet-container">
    <div class="card">

        <h2 class="logo">🐾 PawMatch</h2>
        <h3>Add New Pet</h3>

        <input class="input" placeholder="Pet Name" @bind="petName" />
        <input class="input" placeholder="Pet Address" @bind="petAddress" />

        <select class="input" value="@selectedTypeId" @onchange="TypeChanged">
            <option value="0" disabled>Select Pet Type</option>
            @foreach (var t in types)
            {
                <option value="@t.TypeID">@t.Description</option>
            }
        </select>

        <select class="input" value="@selectedRaiceId" @onchange="RaiceChanged" disabled="@(filteredRaices.Count == 0)">
            <option value="0" disabled>Select Pet Breed</option>
            @foreach (var r in filteredRaices)
            {
                <option value="@r.PetRaiceID">@r.Description</option>
            }
        </select>

        <input class="input" placeholder="Pet Birth Year" @bind="petBirthYear" />
        <input class="input" placeholder="Update User ID" @bind="updateUserID" />

        <InputFile OnChange="@HandleFileChange" class="input" />

        <button class="btn" @onclick="AddPetToDB">Add Pet</button>

        <p class="msg">@message</p>

    </div>
</div>

@code {
    // -------------------------------
    // Fields for user input
    // -------------------------------
    string petName = "";
    string petAddress = "";
    string petBirthYear = "";
    string updateUserID = "";
    string message = "";

    // -------------------------------
    // Dropdown data
    // -------------------------------
    List<PetType> types = new List<PetType>();
    List<PetRaice> raices = new List<PetRaice>();
    List<PetRaice> filteredRaices = new List<PetRaice>();

    int selectedTypeId = 0;
    int selectedRaiceId = 0;

    // -------------------------------
    // File upload
    // -------------------------------
    IBrowserFile? uploadedFile = null;

    void HandleFileChange(InputFileChangeEventArgs e)
    {
        uploadedFile = e.File;
    }

    protected override async Task OnInitializedAsync()
    {
        PetTypeDB tdb = new PetTypeDB();
        PetRaiceDB rdb = new PetRaiceDB();

        types = await tdb.GetAllAsync();
        raices = await rdb.GetAllAsync();

        if (types.Count > 0)
        {
            selectedTypeId = types[0].TypeID;
            RefreshRaicesByType();
        }
    }

    void RefreshRaicesByType()
    {
        filteredRaices = raices
            .Where(x => x.PetTypeID.HasValue && x.PetTypeID.Value == selectedTypeId)
            .ToList();

        selectedRaiceId = filteredRaices.Count > 0 ? filteredRaices[0].PetRaiceID : 0;
    }

    void TypeChanged(ChangeEventArgs e)
    {
        if (e.Value == null) return;

        if (int.TryParse(e.Value.ToString(), out int id))
        {
            selectedTypeId = id;
            RefreshRaicesByType();
        }
    }

    void RaiceChanged(ChangeEventArgs e)
    {
        if (e.Value == null) return;

        if (int.TryParse(e.Value.ToString(), out int id))
        {
            selectedRaiceId = id;
        }
    }

    // -------------------------------
    // Add pet to database
    // -------------------------------
    async Task AddPetToDB()
    {
        if (petName == "" || petAddress == "" || petBirthYear == "" || updateUserID == "")
        {
            message = "All fields must be filled.";
            return;
        }

        if (selectedTypeId == 0)
        {
            message = "Please select a pet type.";
            return;
        }

        if (selectedRaiceId == 0)
        {
            message = "Please select a pet breed.";
            return;
        }

        if (uploadedFile == null)
        {
            message = "Please select an image file.";
            return;
        }

        if (!int.TryParse(petBirthYear, out int birth) || !int.TryParse(updateUserID, out int user))
        {
            message = "Numeric fields must contain only numbers.";
            return;
        }

        // -------------------------------
        // Save image to wwwroot/PetPics
        // -------------------------------
        string folderPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "PetPics");

        if (!Directory.Exists(folderPath))
            Directory.CreateDirectory(folderPath);

        string randomID = Guid.NewGuid().ToString("N").Substring(0, 10);
        string ext = Path.GetExtension(uploadedFile.Name);
        string newFileName = $"{randomID}{ext}";
        string fullPath = Path.Combine(folderPath, newFileName);

        using (var stream = uploadedFile.OpenReadStream(5000000))
        using (var fileStream = File.Create(fullPath))
        {
            await stream.CopyToAsync(fileStream);
        }

        // -------------------------------
        // Create Pet object
        // -------------------------------
        Pet p = new Pet();
        p.PetName = petName;
        p.PetAdress = petAddress;

        p.PetType = selectedTypeId;

        // If your Pet model uses a different property name, change it here.
        p.PetType = selectedRaiceId;

        p.PetBirthYear = birth;
        p.UpdateUserID = user;
        p.IsActive = 1;
        p.PetPicture = newFileName;

        // -------------------------------
        // Insert pet into DB
        // -------------------------------
        PetsDB db = new PetsDB();
        int result = await db.InsertAsync(p);

        if (result > 0)
            message = "Pet added successfully!";
        else
            message = "Error: the pet was not added.";
    }
}

<style>
    .addpet-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background: #f8faf9;
    }

    .card {
        background: white;
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        width: 350px;
        text-align: center;
    }

    .logo {
        color: #2e5f3e;
        margin-bottom: 20px;
    }

    .input {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border: 1px solid #ccc;
        border-radius: 8px;
    }

    .btn {
        width: 100%;
        background-color: #2e5f3e;
        color: white;
        padding: 10px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 10px;
    }

        .btn:hover {
            background-color: #3b724a;
        }

    .msg {
        margin-top: 15px;
        color: #2e5f3e;
        font-weight: bold;
    }
</style>
